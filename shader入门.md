# 1. 渲染流水线

## 1.1 渲染流水线

渲染分为3个阶段：

(1) **应用阶段：**准备数据，如模型，摄像机位置，光源等；看不见物体剔除；设置渲染状态，包括但不限于材质，纹理，Shader等。

(2) **几何阶段：**通常在GPU上执行，进行逐顶点，逐多边形操作，输出屏幕空间的二维顶点坐标，深度值，着色等信息。

(3) **光栅化阶段：**根据上一阶段的数据渲染最终图像。

## 1.2 CPU和GPU的通信

渲染流水线的起点是CPU，即应用阶段，分为：

(1) 把数据加载到显存：所需的数据都从硬盘加载到内存，网格信息，法线方向，顶点颜色，纹理坐标等加载到显存。

(2) 设置渲染状态：包括顶点着色器，片源着色器，光源属性，材质等。

(3) 调用Draw Call：调用后GPU会把图元渲染到屏幕上。

## 1.3 GPU流水线

流水线阶段：



顶点数据->

**几何阶段：**顶点着色器(可编程)->曲面细分着色器(可编程)->几何着色器(可编程)->剪裁->屏幕映射(可配置)

**光栅化：**三角形设置->三角形遍历->片元着色器->逐片元操作

-> 屏幕图像



### 1.3.1 顶点着色器

**顶点着色器**：输入来自CPU，处理单位是顶点。不能创建或销毁顶点，无法得到顶点间的关系。

主要工作是：坐标变换和逐顶点光照。

**必要**：把顶点坐标从模型空间转换到齐次剪裁空间。



### 1.3.2 裁剪

视野外的图元去除，只有一部分在视野外的会重新设置图元。



### 1.3.3 屏幕映射

将图元x,y坐标转换为屏幕坐标系（二维坐标），z值会保留



### 1.3.4 三角形设置

计算三角形边界。



### 1.3.5 三角形遍历

计算哪些顶点在三角形中，并插值得到深度等信息。



### 1.3.6 片元着色器

片元着色器的输入是顶点信息的插值。该阶段输出像素的颜色值。



### 1.3.7 逐片元操作

OpenGL叫逐片元操作，DirectX叫输出合并阶段。

(1) 决定每个片元的可见性，包括深度测试，模板测试等

(2) 如果通过了所有测试，就把这个片元的颜色值和已经存储在缓冲区的颜色进行合并，或混合





## 1.4 HLSL、GLSL、Cg

这些都是着色语言。

HSLS：DirectX的着色语言

GLSL：OpenGL

Cg：NVIDIA

这些都是高级语言，他们被翻译为IL，然后交给驱动程序执行。

GLSL跨平台，编译结果取决于硬件供应商。

HLSL仅支持微软自己的产品。

Cg真正的跨平台，根据平台不同，编译成相应的中间语言。但无法发挥OpenGL最新特性。



## 1.5 Draw Call

Draw Call将渲染模型放入GPU的命令缓存区。

Draw Call调用有额外开销，应当使用批处理的方式发起Draw Call。

在开发过程中，

(1) 避免使用过多小网格

(2) 避免使用过多材质

## 1.6 固定管线渲染

固定管线在较旧的GPU上使用，流水线只提供一些配置操作。



# 2. UnityShader基础

### 2.1 Unity Shader 概述

**Unity可创建Shader类型：**

(1) Standard Surface Shader：标准光照模型

(2) Image Effect Shader：用于屏幕后处理

(3) Compute Shader：利用GPU并行性做些和流水线无关的操作

(4) Unity Shader：一个不含光照，但包含雾效的Shader